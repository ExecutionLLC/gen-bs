<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <title>ExGe - VCF File Validation</title>
    <!--<link rel="stylesheet" media="all" href="style.css">
    <link rel="stylesheet" media="all" href="v2-combined.min.css">-->
</head>
<body>
<style>
    #progress_bar {
        margin: 10px 0;
        padding: 3px;
        border: 1px solid #000;
        font-size: 14px;
        clear: both;
        opacity: 0;
        -moz-transition: opacity 1s linear;
        -o-transition: opacity 1s linear;
        -webkit-transition: opacity 1s linear;
    }
    #progress_bar.loading {
        opacity: 1.0;
    }
    #progress_bar .percent {
        background-color: #99ccff;
        height: auto;
        width: 0;
    }
</style>

<input type="file" id="files" name="file" />

<script>
    function LineReader(file) {
        this.file = file;
        this.reader = new FileReader();
        this.offset = 0;
        this.currentLine = "";
        this.bufferOffset = 0;
        this.lastBuffer = null;
        this.callback = null;
        this.omittedCR = false;
        this.sawCR = false;
        this.decodeOptions = {"stream":true}
        this.decoder = new TextDecoder("utf-8",{"ignoreBOM":true});
        this.reader.addEventListener("load",this._viewLoaded.bind(this));
        this.reader.addEventListener("error",this._error.bind(this));
    }

    LineReader.prototype._error = function(e) {
        throw e;
    }

    LineReader.prototype._readFromView = function(a, offset){
        for(var i = offset; i < a.length; i++){
            // Treats LF and CRLF as line breaks
            if(a[i] == 0x0A){
                // Line feed read
                var lineEnd=(this.sawCR ? i - 1 : i);
                if(lineEnd > 0) {
                    this.currentLine += this.decoder.decode(a.slice(this.bufferOffset, lineEnd),  this.decodeOptions);
                }
                if(this.callback) {
                    this.callback(this.currentLine)
                }
                this.decoder.decode(new Uint8Array([]))
                this.currentLine = "";
                this.sawCR = false;
                this.bufferOffset = i + 1;
                this.lastBuffer = a;
            } else if(a[i] == 0x0D) {
                if(this.omittedCR) {
                    this.currentLine += "\r";
                }
                this.sawCR = true;
            } else if (this.sawCR) {
                if (this.omittedCR) {
                    this.currentLine += "\r";
                }
                this.sawCR = false;
            }
            this.omittedCR = false;
        }
        if(this.bufferOffset != a.length) {
            // Decode the end of the line if no current line was reached
            var lineEnd = (this.sawCR ? a.length - 1 : a.length);
            if(lineEnd > 0) {
                this.currentLine += this.decoder.decode(a.slice(this.bufferOffset, lineEnd), this.decodeOptions);
            }
            this.omittedCR = this.sawCR;
        }
    }

    LineReader.prototype._viewLoaded = function() {
        var a = new Uint8Array(this.reader.result);
        if(a.length > 0) {
            this.bufferOffset = 0;
            this._readFromView(a, 0);
            this.offset += a.length;
            var s = this.file.slice(this.offset, this.offset + 256);
            this.reader.readAsArrayBuffer(s);
        } else {
            if(this.callback && this.currentLine.length > 0) {
                this.callback(this.currentLine);
            }
            this.decoder.decode(new Uint8Array([]));
            this.currentLine = "";
            this.sawCR = false;
        }
    }

    LineReader.prototype.readLines = function(callback){
        this.callback = callback;
        var s = this.file.slice(this.offset, this.offset + 8192);
        this.reader.readAsArrayBuffer(s);
    }

    function handleFileSelect(evt) {
        var i = 0;
        new LineReader(evt.target.files[0]).readLines(function(line) {
            //if (i < 5) {
                document.write(line +   '<br>');
                //document.write(i + " : " + line + 0x0A);
            //}
            i++;
        });
        document.write(i);
    }

    document.getElementById('files').addEventListener('change', handleFileSelect, false);
</script>
</body>
</html>