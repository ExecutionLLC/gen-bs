# Регистрационный сервер

Служит для хранения временной информации о желающем зарегистрироваться пользователе.

Процесс регистрации изменялся со временем, поэтому часть из имеющегося функционала и данных не используется, о чём будет упомянуто.

Регистрация пользователя на вебсервере производится непосредственно на нём, регистрационный сервер для этого не нужен. Речь идёт именно о накоплении данных о пользователе, который желает зарегистрироваться, то есть запросов на регистрацию.

Запрос на регистрацию осуществляется на сайте [http://alapy.com/join-pioneers](),на котором размещается форма для заполнения пользовательских данных. Среди них: обязательный e-mail, имя, фамилия, номер телефона, пол, специальность и название компании. Кроме того выбирается тип логина: по email и паролю (в этом случае вводится и подтверждается пароль) или через Google.

Запрос на регистрацию изначально мог быть в двух вариантах: с использованием регистрационного кода и без него. Позже функционал регистрационного кода был убран, но таблицы и множество кода оставлены без изменений, с тем, чтобы этот функционал можно было вернуть.

Исходный код и всё относящееся к работе регистрационного сервега находится в репозитории [gen-bs](https://github.com/ExecutionLLC/gen-bs), в папке [registration](https://github.com/ExecutionLLC/gen-bs/tree/master/registration).

## Регистрация с использованием регистрационного кода

*Функционал отключен, но часть кода и структура таблиц оставлены. Ниже описано поведение с включенным функционалом.*

Регистрационный код - код, выдаваемый пользователю, к которым он имеет некоторые преимущества при регистрации, например, он может вводить вышеозначенную информацию о себе, которая будет сохраняться между входами на сайт регистрации, а также имеет возможность зарегистрироваться без ожидания одобрения от администратора (одобрение администратора также убрано). Представляет собой восьмизначный номер. Для удобства пользователя ему может выдаваться ссылка, содержащая UUID кода, чтобы не требовался его ввод.

При вводе регистрационного кода на странице регистрации или при переходе на страницу регистрации по ссылке, сгенерированной при генерации регкода происходит следующее: поле ввода регкода становится только для чтения, последние введённые данные пользователем с этим регкодом заполняются в поля ввода. При заполнении полей пользователем они сохраняются автоматически или при нажатии на кнопки регистрации через Google или через логин и пароль. Это позволяет пользователю закрыть страницу с частично ведёнными данными и продолжить заполнение позже.

При завершении регистрации пользователю в почту высылается ссылка для подтверждения, при переходе по которой происходит добавление пользователя с введёнными для регкода данными на вебсервер и активация регкода, то есть отметка о его использовании.

<a name="user-request"></a>
## Регистрация без использования регистрационного кода

При отсутствиии у пользователя регистрационного кода он может заполнять регистрационную форму как и при его наличии, но вводимые данные не будут сохраняться.

При завершении ввода данных и выборе способа логина данные пользователя сохраняются, и пользователю высылается письмо со ссылкой для подтверждения адреса электронной почты.

*Функционал, описанный в этом абзаце удалён, но часть кода и структура таблиц оставлены. После подтверждения пользователем своего адреса администратору высылается письмо с данными пользователя и ссылкой на его одобрение. При переходе по ссылке пользователь с его введёнными данными добавляется на вебсервер. После этого пользователю присылается письмо с приглашением залогиниться на сайт.*

*Так как от подтверждения пользователя администратором отказались, то функционал добавления пользователя упрощён и теперь он такой.* После подтверждения пользователем адреса электронной почты его введённые данные используются для добавления пользователя на вебсервер, после чего пользователю присылается письмо с приглашением залогиниться на сайт.

<a name="adduser"></a>
## Добавление пользователя

Для добавления пользователя используется запрос на вебсервер. Для того, чтобы добавить пользователя не мог кто угодно, дополнительно передаётся секретный ключ для добавления. Учитывая небольшую заинтересованную аудиторию и некритичность хранимых данных решили не использовать криптографических методов.

Ключ для добавления пользователя представляет собой произвольную строку, сейчас используется сгенерированный UUID. При обработке добавления пользователя она сравнивается с хранимой на вебсервере.

<a name="frontend"></a>
## Веб-интерфейс

Веб-интерфейс регистрации размещается на стороннем сайте [http://alapy.com/](), сделан конструктором Вордпресса с добавлением кастомных стилей и яваскрипт-кода. Код страницы и стелей сохранён в репозитории в папке `wordpress`.

Для редактирования страниц и просмотра неопубликованных необходимо залогиниться под админом сайта.

Относящиеся к регистрации страницы:

<a name="frontend-registration"></a>
### Регистрация

На странице регистрации пользователь может подать заявку на регистрацию на вебсервере. Для этого нужно в поля формы ввести свои данные: имя, фалилию, пол, номер телефона (не обязательно), название организации, специальность.

*Функционал, описанный в этом абзаце удалён, но часть кода оставлена, потому функционал описан. При наличии регистрационного кода его нужно ввести в соответствующее поле ввода или сразу перейти по ссылке, генерируемой с реристрационным кодом. При этом данные, ассоциированные с кодом будут заполнены в поля формы и поле ввода регистрационного кода будет сделано недоступным для редактирования. Данные для регистрационного кода создаются при его генерации и сохраняются при изменениях на странице регистрации. При регистрации без регистрационного кода вводимые данные не сохраняются.*

После заполнения данных, подтверждения лицензионного соглашения и ввода капчи пользователь выбирает способ авторизации на веб-сервере: с паролем или через Google. В первом случае будет предложено ввести и подтвердить пароль. После этого на этой же странице показывается сообщение об отправленном письме. Дальнейшее описано [выше](#user-request).

Ссылка на страницу: [http://alapy.com/join-pioneers/]().

Ссылка на редактирование: [http://alapy.com/wp-admin/post.php?post=616&action=edit]().

Страница загружает скрипты с регистрационного сервера, их адреса прописаны в коде страницы, отдаются они регистрационным сервером из папки `public`:

* `http://agx.alapy.com/register/promise.js` - библиотека поддержки `Promise`;
* `http://agx.alapy.com/register/config.js` - файл констант конфигурации;
* `http://agx.alapy.com/register/index.js` - основной код страницы;

Кроме того загружаются сторонние скрипты: [reCaptcha](https://www.google.com/recaptcha/intro/invisible.html) и [Hotjar](https://www.hotjar.com/) - сервис записи действий пользователя.

Для тестирования регистрации заведены ещё две страницы:

Ссылка: [http://alapy.com/wp-admin/post.php?post=1662&action=edit]().

Редактирование: [http://alapy.com/join-pioneers-alpha/]().

Ссылка: [http://alapy.com/wp-admin/post.php?post=1692&action=edit]().

Редактирование: [http://alapy.com/join-pioneers-test/]().

Нужно обратить внимание на различия в скриптах этих страниц, точнее на ссылки на сервера, чтобы тестовые страницы работали только с тестовыми регистрационными серверами, а боевой - с боевым.

<a name="frontend-mail-confirmed"></a>
### Страница уведомления о подтверждении почты

Ссылка на страницу: [http://alapy.com/email-confirmed/]().

Ссылка на редактирование: [http://alapy.com/wp-admin/post.php?post=1910&action=edit]().

Информационная страница, показывающая пользователю сообщение об успешном подтверждении его почты.

<a name="admin_pages"></a>
### Страницы для администратора

Для просмотра текущего состояния заполнения данных пользователями с регкодами, текущих запросов на регистрацию без регкодов, одобрения пользователей и прочего есть админские страницы. В них выводится информация из таблиц, см. [их описание](#tables).

Страницы статичные, отдаются из папки `public`, их имена можно посмотреть там же. UUID в названии сгенерированы случайно, чтобы данные были доступны только тем, кто имеет ссылку. Для примера, на `agx.alapy.com` эти страницы имеют адреса:

* https://agx.alapy.com/register/3a92a566-caf6-4f17-a23e-1cd7f728d166.html

* https://agx.alapy.com/register/3a92a566-caf6-4f17-a23e-1cd7f728d166-regcodes.html

* https://agx.alapy.com/register/3a92a566-caf6-4f17-a23e-1cd7f728d166-requests.html

В коде страниц также есть код, отправляемый в запросах на получение данных с регистрационного сервера. Это также случайно сгенерированный UUID, но так как его значение получает тот, кто открывает страницу, то он совпадает с UUID в адресе страницы. На вебсервере это значение настраивается в переменной окружения [GEN_REG_ADMIN_DATA_KEY](#GEN_REG_ADMIN_DATA_KEY).

<a name="mailing"></a>
## Рассылка почты

Рассылка почты пользователям и админу делается при помощи сервиса [Mandrill](https://mandrillapp.com/), шаблоны писем хранятся на [MailChimp](https://mailchimp.com/). Ключ рассылки берётся из переменной окружения [GEN_WS_MAIL_KEY](#GEN_WS_MAIL_KEY).

Шаблоны писем:

* [successful-user-register](https://mandrillapp.com/templates/code?id=successful-user-register), шаблон на Mailchimp: [https://us14.admin.mailchimp.com/templates/edit?id=17715]() - письмо об успешной регистрации.
* [application-for-registration-with-email-confirmation](https://mandrillapp.com/templates/code?id=application-for-registration-with-email-confirmation), шаблон на Mailchimp: [https://us14.admin.mailchimp.com/templates/edit?id=17723](), с правками - письмо со ссылкой для подтверждения email.

<a name="tables"></a>
## Таблицы

### registration_code

Таблица регистрационных кодов и частично введённая пользовательская информация для них. Генерируются на сервере скриптом [`user:generate-codes`](#regcode-generation). Поля таблицы:

Данные регкода, задаваемые скриптом создания:
* `id` - UUID кода;
* `regcode` - текстовое представление кода;
* `description` - описание регкода;
* `language` - язык пользователя;
* `number_of_paid_samples` - количество оплаченных сэмплов; *функционал оплаты не реализован, количество оплаченных сэмплов сохраняется для каждого пользователя, но не используется;*
* `created_timestamp` - время создания;

Пользовательские данные:
* `first_name` - имя;
* `last_name` - фамилия;
* `gender` - пол, строковые данные;
* `speciality` - специальность; значение задаётся при создании регкода, но может быть изменено пользователем;
* `company` - компания;
* `email` - email;
* `telephone` - номер телефона в произвольном формате;

Служебная информация:
* `first_date` - время первого запроса пользовательских данных, указывает на первое открытие страницы ввода данных с этим регкодом;
* `last_date` - время последней записи пользовательских данных, указывает на последнее редактирование данных;
* `is_activated` - булевский признак активации регкода; регистрация активированного регкода исключается, редактрование данных выключается, на странице регистрации показывается ссылка на логин в вебсервер;
* `activated_timestamp` - время установки признака активации;

### user_request

Введённе пользователем данные, ожидающие одобрения и добавление я на вебсервер.

Данные заполняемые при создании:
* `id` - UUID пользовательских данных;
* `email_confirm_uuid` - UUID, высылаемый на почту для её подтверждения (UUID подтверждения почты); отличен от `id` для того, чтобы нельзя было по `id` сформировать ссылку подтверждения почты и тем самым зарегистрироваться на не свой email;

Пользовательские данные:
* `first_name` - имя;
* `last_name` - фамилия;
* `gender` - пол, строковые данные;
* `speciality` - специальность;
* `company` - компания;
* `email` - email;
* `telephone` - номер телефона в произвольном формате;
* `login_type` - выбранный тип логина: `'password'` для логина/пароля и `'google'` для логина через Google;
* `password` - пароль, если выбран логин через логин/пароль, иначе `null`;

Служебная информация:
* `is_activated` - булевский признак добавление пользователя с этой информацией на вебсервер;
* `activated_timestamp` - время установки признака добавления пользователя;
* `created_timestamp` - время создания;
* `email_confirm_send_timestamp` - время отправки письма со ссылкой для подтверждения почты;
* `email_confirmed` - признак подтверждения почты, то есть открытия ссылки подтверждения;
* `email_confirmed_timestamp` - признак подтверждения почты;

## Переменные окружения

Значения переменных окружения, которые не определены, берутся из объекта, хранимого в файле `default-env.json`, если их нет и там - берутся значения по умолчанию. Порядок загрузки и зеначения по умолчанию можно посмотреть в файле `Config.js`.

Настройки регистрационного сервера:
* `GEN_REG_PORT` - порт регистрационного сервера, на котором он будет запущен;
* `GEN_REG_BASE_URL` - урл регистрационного сервера, используется для формирования урла подтверждения почты;
* *`GEN_REG_CORS_ENABLE` - не используется, можно удалить;*
* *`GEN_REG_DISABLE_REQUEST_LIMITS` - не используется, можно удалить;*
<a name="GEN_REG_ADMIN_DATA_KEY"></a>
* `GEN_REG_ADMIN_DATA_KEY` - секретная строка (сейчас используется UUID, но это не обязательно) для доступа к функциям, возвращающим информацию по запросам на регистрацию и по регистрационным кодам, по сути выборку из БД; такие запросы посылаются с [админских страниц](#admin_pages);

Настройки БД:
* `GEN_REG_DATABASE_HOST` - хост;
* `GEN_REG_DATABASE_PORT` - порт;
* `GEN_REG_DATABASE_USER` - имя пользователя;
* `GEN_REG_DATABASE_PASSWORD` - пароль;
* `GEN_REG_DATABASE_NAME` - имя БД;

Настройки логирования (см. `utils/Logger.js`):
* `GEN_REG_CONSOLE_LOG_LEVEL` - уровень логирования в консоль;
* `GEN_REG_LOG_LEVEL` - уровень логирования в файл;
* `GEN_REG_LOG_PATH` - путь к файлу лога;

Настройки вебсервера, сейчас используются только для запроса на добавление пользователя:
* `GEN_REG_WS_SCHEME` - протокол (`http`/`https`);
* `GEN_REG_WS_HOST` - хост;
* `GEN_REG_WS_PORT` - порт;
* `GEN_REG_WS_ADD_USER_KEY` - секретная строка для добавления пользователя, см. [добавление пользователя](#adduser);

Настройки фронтенда, используется для формирования ссылок на регистрацию при редиректе на страницу при подтверждении почты и при формировании регистрационного кода:
* `GEN_REG_FRONTEND_SITE` - урл сайта фронтенда;
* `GEN_REG_FRONTEND_REGCODE_ID_PATH` - путь к регистрации с регкодом, см. [регистрацию](frontend-registration);
* `GEN_REG_FRONTEND_EMAIL_CONFIRMED` - путь к странице, открываемой после успешного подтверждения почты, см. [страницу уведомления о подтверждении почты](#frontend-mail-confirmed);

настройки рассылки посем:
* `GEN_WS_MAIL_KEY` - ключ для API вызовов Mandrill (генерируется и смотрится на сайте в настройках, см. [рассылку почты](#mailing));
* `GEN_WS_MAIL_ADMIN_MAIL` - *почта админа, одобряющего заявки на регистрацию, не используется, см. [регистрацию пользователя без регистрационного кода](#user-request)*;
* `GEN_WS_MAIL_FROM_MAIL` - обратный почтовый адрес;
* `GEN_WS_MAIL_FROM_NAME` - имя отправителя;

Имена шаблонов рассылаемых писем (см. [рассылку почты](#mailing)):
* `GEN_WS_MAIL_USER_REGISTER_TEMPLATE` - письмо со ссылкой для подтверждения email для пользователя без регкода;
* `GEN_WS_MAIL_USER_REGISTER_CODE_TEMPLATE` - письмо со ссылкой для подтверждения email для пользователя с регкодом;
* `GEN_WS_MAIL_USER_REGISTER_APPROVE_TEMPLATE` - письмо пользователю о том, что он может войти на сайт;
* `GEN_WS_MAIL_ADMIN_REGISTER_TEMPLATE` - *(функционал выключен, переменная не используется) письмо админу о том, что пользователем (без регкода) отправлена заявка на регистрацию; см. [регистрацию пользователя без регистрационного кода](#user-request);*
* `GEN_WS_MAIL_ADMIN_REGISTER_APPROVE_TEMPLATE` - *(функционал выключен, переменная не используется) письмо админу о том, что пользователь (без регкода) им успешно добавлен; см. [регистрацию пользователя без регистрационного кода](#user-request);*

## Запуск

Для запуска регистрационного сервера производится выполнение файла `index.js` интерпретатором `nodejs` 6-й версии. Скрипт прописан как стартовый в `packege.json` и может быть запущен командой `npm start`.

На лайве скрипт запускается при помощи [pm2](http://pm2.keymetrics.io/). **вставить ссылку на разоворачивание сервера**

## Скрипты

Все скрипты, доступные для запуска на сервере, описаны в `package.json` и запускаются командой `npm run <скрипт>`.

* `test` - запуск тестов;
* `db:create` - создание БД;
* `db:reset` - заполнение БД значениями по умолчанию, запуск всех миграций;
* `db:migrate` - выполнение миграции БД;
* `user:generate-codes` - генерация регистрационных кодов, подробнее о ней см. ниже;

<a name="regcode-generation"></a>
### Генерация регистрационных кодов

При запуске `npm run user:generate-codes` без параметров отображается справка по использованию со списком ключей:

* `--count` - количество генерируемых регистрационных кодов;
* `--speciality` - специальность, заполняемая для каждого кода; при регистрации с этим кодом это значение будет отображаться пользователю, но он сможет его изменить;
* `--description` - описание генерируемых кодов; значение не отображается пользователю, но сохраняется в таблице;
* `--defaultLanguage` - язык пользователей создаваемых кодов; после регистрации с создаваемыми кодами указанный язык будет применен как язык пользователя; Указывается при генерации регистрационного кода, потмоу что пользователь при регистрации язык не выбирает;
* `--numberPaidSamples` - количество проплаченных сэмплов для каждого пользователя, зарегистрировавшегося с этим кодом; *сейчас оплата не поддерживается, это значение присваивается зарегистрированному с данным кодом пользователю, но далее не используется;*
* `--startRegcode` - опциональный параметр, начальный код; при указании этого параметра генерируется указанное количество кодов, начиная с данного и с последовательным инкрементом; Уже занятые коды пропускаются;

Результатом работы является список регистрационных кодов, их `id` и ссылки для перехода с заполненным кодом.

Пример использования:

`npm run user:generate-codes -- --count 5 --speciality medic --description "generation test" --defaultLanguage en --numberPaidSamples 10 --startRegcode 23938885`

В конце работы скрипт выдаёт:

```
5 registration codes are added with ids: [ 'e7c5eacc-7049-4f66-9895-7cf1e4fa475b',
  '7c982f12-a234-476e-ad5a-b3a13a333d71',
  'a13bfc67-1576-4477-8ac0-9104740b83f3',
  '9a564508-5a7e-45bf-a825-419bf33622db',
  '7dacb2da-3e5d-48ab-8870-afd9b2e16c5c' ]
23938885: http://alapy.com/register/#e7c5eacc-7049-4f66-9895-7cf1e4fa475b
23938890: http://alapy.com/register/#7c982f12-a234-476e-ad5a-b3a13a333d71
23938889: http://alapy.com/register/#a13bfc67-1576-4477-8ac0-9104740b83f3
23938887: http://alapy.com/register/#9a564508-5a7e-45bf-a825-419bf33622db
23938886: http://alapy.com/register/#7dacb2da-3e5d-48ab-8870-afd9b2e16c5c
```

Можно заметить, что кода `23938888` нет, это потому что такой код уже был в БД на момент запуска скрипта. 