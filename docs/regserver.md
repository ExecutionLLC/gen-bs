# Регистрационный сервер

Служит для хранения временной информации о желающем зарегистрироваться пользователе.

Процесс регистрации изменялся со временем, поэтому часть из имеющегося функционала и данных не используется, о чём будет упомянуто.

Регистрация пользователя на вебсервере производится непосредственно на нём, регистрационный сервер для этого не нужен. Речь идёт именно о накоплении данных о пользователе, который желает зарегистрироваться, то есть запросов на регистрацию.

Запрос на регистрацию осуществляется на сайте [http://alapy.com/join-pioneers](),на котором размещается форма для заполнения пользовательских данных. Среди них: обязательный e-mail, имя, фамилия, номер телефона, пол, специальность и название компании. Кроме того выбирается тип логина: по email и паролю (в этом случае вводится и подтверждается пароль) или через Google.

Запрос на регистрацию изначально мог быть в двух вариантах: с использованием регистрационного кода и без него. Позже функционал регистрационного кода был убран, но таблицы и множество кода оставлены без изменений, с тем, чтобы этот функционал можно было вернуть.

## Регистрация с использование регистрационного кода

*Функционал отключен, но часть кода и структура таблиц оставлены. Ниже описано поведение с включенным функционалом.*

Регистрационный код - код, выдаваемый пользователю, к которым он имеет некоторые преимущества при регистрации, например, он может вводить вышеозначенную информацию о себе, которая будет сохраняться между входами на сайт регистрации, а также имеет возможность зарегистрироваться без ожидания одобрения от администратора (одобрение администратора также убрано). Представляет собой восьмизначный номер. Для удобства пользователя ему может выдаваться ссылка, содержащая UUID кода, чтобы не требовался его ввод.

При вводе регистрационного кода на странице регистрации или при переходе на страницу регистрации по ссылке, сгенерированной при генерации регкода происходит следующее: поле ввода регкода становится только для чтения, последние введённые данные пользователем с этим регкодом заполняются в поля ввода. При заполнении полей пользователем они сохраняются автоматически или при нажатии на кнопки регистрации через Google или через логин и пароль. Это позволяет пользователю закрыть страницу с частично ведёнными данными и продолжить заполнение позже.

При завершении регистрации пользователю в почту высылается ссылка для подтверждения, при переходе по которой происходит добавление пользователя с введёнными для регкода данными на вебсервер и активация регкода, то есть отметка о его использовании.

## Регистрация без использования регистрационного кода

При отсутствиии у пользователя регистрационного кода он может заполнять регистрационную форму как и при его наличии, но вводимые данные не будут сохраняться.

При завершении ввода данных и выборе способа логина данные пользователя сохраняются, и пользователю высылается письмо со ссылкой для подтверждения адреса электронной почты.

*Функционал, описанный в этом абзаце удалён, но часть кода и структура таблиц оставлены. После подтверждения пользователем своего адреса администратору высылается письмо с данными пользователя и ссылкой на его одобрение. При переходе по ссылке пользователь с его введёнными данными добавляется на вебсервер. После этого пользователю присылается письмо с приглашением залогиниться на сайт.*

*Так как от подтверждения пользователя администратором отказались, то функционал добавления пользователя упрощён и теперь он такой.* После подтверждения пользователем адреса электронной почты его введённые данные используются для добавления пользователя на вебсервер, после чего пользователю присылается письмо с приглашением залогиниться на сайт.

## <a name="adduser"></a>Добавление пользователя

Для добавления пользователя используется запрос на вебсервер. Для того, чтобы добавить пользователя не мог кто угодно, дополнительно передаётся секретный ключ для добавления. Учитывая небольшую заинтересованную аудиторию и некритичность хранимых данных решили не использовать криптографических методов.

Ключ для добавления пользователя представляет собой произвольную строку, сейчас используется сгенерированный UUID. При обработке добавления пользователя она сравнивается с хранимой на вебсервере.

## Веб-интерфейс

Веб-интерфейс регистрации размещается на стороннем сайте [http://alapy.com/](), сделан конструктором Вордпресса с добавлением кастомных стилей и яваскрипт-кода.

Для редактирования страниц и просмотра неопубликованных необходимо залогиниться под админом сайта.

Относящиеся к регистрации страницы:

### Регистрация

Ссылка на страницу: [http://alapy.com/join-pioneers/]().

Ссылка на редактирование: [http://alapy.com/wp-admin/post.php?post=616&action=edit]().

Страница загружает скрипты с регистрационного сервера, их адреса прописаны в коде страницы, отдаются они регистрационным сервером из папки `public`:

* `http://agx.alapy.com/register/promise.js` - библиотека поддержки `Promise`;
* `http://agx.alapy.com/register/config.js` - файл констант конфигурации;
* `http://agx.alapy.com/register/index.js` - основной код страницы;

Кроме того загружаются сторонние скрипты: Google reCaptcha и Hotjar - сервис записи действий пользователя.

**вставить ссылку на hotjar и рекапчу**

Для тестирования регистрации заведены ещё две страницы:

Ссылка: [http://alapy.com/wp-admin/post.php?post=1662&action=edit]().

Редактирование: [http://alapy.com/join-pioneers-alpha/]().

Ссылка: [http://alapy.com/wp-admin/post.php?post=1692&action=edit]().

Редактирование: [http://alapy.com/join-pioneers-test/]().

Нужно обратить внимание на различия в скриптах этих страниц, точнее на ссылки на сервера, чтобы тестовые страницы работали только с тестовыми регистрационными серверами, а боевой - с боевым.

### Страница уведомления об отправки письма

Ссылка на страницу: [http://alapy.com/email-confirmed/]().

Ссылка на редактирование: [http://alapy.com/wp-admin/post.php?post=1910&action=edit]().

Информационная страница, показывающая пользователю сообщение об отправке ему письма с подтверждением регистрации.

### Страницы для администратора




**про alapy.com, адреса темплейтов, пароли**

**ещё про админскую страницу**

## Рассылка почты

**mailchimp и темплейты, пароли**

## Таблицы

### registration_code

Таблица регистрационных кодов и частично введённая пользовательская информация для них. Генерируются на сервере скриптом **TODO вставить ссылку**. Поля таблицы:

Данные регкода, задаваемые скриптом создания:
* `id` - UUID кода;
* `regcode` - текстовое представление кода;
* `description` - описание регкода;
* `language` - язык пользователя;
* `number_of_paid_samples` - количество оплаченных сэмплов;
* `created_timestamp` - время создания;

Пользовательские данные:
* `first_name` - имя;
* `last_name` - фамилия;
* `gender` - пол, строковые данные;
* `speciality` - специальность; значение задаётся при создании регкода, но может быть изменено пользователем;
* `company` - компания;
* `email` - email;
* `telephone` - номер телефона в произвольном формате;

Служебная информация:
* `first_date` - время первого запроса пользовательских данных, указывает на первое открытие страницы ввода данных с этим регкодом;
* `last_date` - время последней записи пользовательских данных, указывает на последнее редактирование данных;
* `is_activated` - булевский признак активации регкода; регистрация активированного регкода исключается, редактрование данных выключается, на странице регистрации показывается ссылка на логин в вебсервер;
* `activated_timestamp` - время установки признака активации;

### user_request

Введённе пользователем данные, ожидающие одобрения и добавление я на вебсервер.

Данные заполняемые при создании:
* `id` - UUID пользовательских данных;
* `email_confirm_uuid` - UUID, высылаемый на почту для её подтверждения (UUID подтверждения почты); отличен от `id` для того, чтобы нельзя было по `id` сформировать ссылку подтверждения почты и тем самым зарегистрироваться на не свой email;

Пользовательские данные:
* `first_name` - имя;
* `last_name` - фамилия;
* `gender` - пол, строковые данные;
* `speciality` - специальность;
* `company` - компания;
* `email` - email;
* `telephone` - номер телефона в произвольном формате;
* `login_type` - выбранный тип логина: `'password'` для логина/пароля и `'google'` для логина через Google;
* `password` - пароль, если выбран логин через логин/пароль, иначе `null`;

Служебная информация:
* `is_activated` - булевский признак добавление пользователя с этой информацией на вебсервер;
* `activated_timestamp` - время установки признака добавления пользователя;
* `created_timestamp` - время создания;
* `email_confirm_send_timestamp` - время отправки письма со ссылкой для подтверждения почты;
* `email_confirmed` - признак подтверждения почты, то есть открытия ссылки подтверждения;
* `email_confirmed_timestamp` - признак подтверждения почты;

## Переменные окружения

Значения переменных окружения, которые не определены, берутся из объекта, хранимого в файле `default-env.json`, если их нет и там - берутся значения по умолчанию. Порядок загрузки и зеначения по умолчанию можно посмотреть в файле `Config.js`.

Настройки регистрационного сервера:
* `GEN_REG_PORT` - порт регистрационного сервера, на котором он будет запущен;
* `GEN_REG_BASE_URL` - урл регистрационного сервера, используется для формирования урла подтверждения почты;
* *`GEN_REG_CORS_ENABLE` - не используется, можно удалить;*
* *`GEN_REG_DISABLE_REQUEST_LIMITS` - не используется, можно удалить;*
* `GEN_REG_ADMIN_DATA_KEY` - секретная строка (сейчас используется UUID, но это не обязательно) для доступа к функциям, возвращающим информацию по запросам на регистрацию и по регистрационным кодам, по сути выборку из БД; **вставить ссылку на админскую страницу**

Настройки БД:
* `GEN_REG_DATABASE_HOST` - хост;
* `GEN_REG_DATABASE_PORT` - порт;
* `GEN_REG_DATABASE_USER` - имя пользователя;
* `GEN_REG_DATABASE_PASSWORD` - пароль;
* `GEN_REG_DATABASE_NAME` - имя БД;

Настройки логирования (см. `utils/Logger.js`):
* `GEN_REG_CONSOLE_LOG_LEVEL` - уровень логирования в консоль;
* `GEN_REG_LOG_LEVEL` - уровень логирования в файл;
* `GEN_REG_LOG_PATH` - путь к файлу лога;

Настройки вебсервера, сейчас используются только для запроса на добавление пользователя:
* `GEN_REG_WS_SCHEME` - протокол (`http`/`https`);
* `GEN_REG_WS_HOST` - хост;
* `GEN_REG_WS_PORT` - порт;
* `GEN_REG_WS_ADD_USER_KEY` - секретная строка для добавления пользователя, см. [добавление пользователя](#adduser); **вставить ссылку**

Настройки фронтенда, используется для формирования ссылок на регистрацию при редиректе на страницу при подтверждении почты и при формировании регистрационного кода **вставить ссылку на описание сайта**:
* `GEN_REG_FRONTEND_SITE` - урл сайта фронтенда;
* `GEN_REG_FRONTEND_REGCODE_ID_PATH` - путь к регистрации с регкодом **вставить ссылку на описание страницы**;
* `GEN_REG_FRONTEND_EMAIL_CONFIRMED` - путь к странице, открываемой после успешного подтверждения почты **вставить ссылку на описание страницы**;

настройки рассылки посем:
* `GEN_WS_MAIL_KEY` - ;
* `GEN_WS_MAIL_ADMIN_MAIL` - ;
* `GEN_WS_MAIL_FROM_MAIL` - ;
* `GEN_WS_MAIL_FROM_NAME` - ;

Имена шаблонов рассылаемых писем (**вставить ссылку на описание рассылок**):
* `GEN_WS_MAIL_USER_REGISTER_TEMPLATE` - письмо со ссылкой для подтверждения email для пользователя без регкода;
* `GEN_WS_MAIL_USER_REGISTER_CODE_TEMPLATE` - письмо со ссылкой для подтверждения email для пользователя с регкодом;
* `GEN_WS_MAIL_USER_REGISTER_APPROVE_TEMPLATE` - письмо пользователю о том, что он может войти на сайт;
* `GEN_WS_MAIL_ADMIN_REGISTER_TEMPLATE` - *(функционал выключен, переменная не используется) письмо админу о том, что пользователем (без регкода) отправлена заявка на регистрацию; **вставить ссылку на процесс добавления пользователей***
* `GEN_WS_MAIL_ADMIN_REGISTER_APPROVE_TEMPLATE` - *(функционал выключен, переменная не используется) письмо админу о том, что пользователь (без регкода) им успешно добавлен; **вставить ссылку на процесс добавления пользователей***;
